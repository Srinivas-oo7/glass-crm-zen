import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { leadId, context } = await req.json();
    const geminiApiKey = Deno.env.get('GEMINI_API_KEY');
    
    if (!geminiApiKey) {
      throw new Error('GEMINI_API_KEY not configured');
    }

    // Initialize Supabase client
    const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Get lead information
    const { data: lead, error: leadError } = await supabase
      .from('leads')
      .select('*')
      .eq('id', leadId)
      .single();

    if (leadError) throw leadError;

    console.log('Drafting email for lead:', lead.name);

    // Generate email with Gemini
    const prompt = `Draft a professional, personalized outreach email for the following lead:

Name: ${lead.name}
Company: ${lead.company || 'Unknown'}
Industry: ${lead.industry || 'Unknown'}
Notes: ${lead.notes || 'No additional notes'}
${context ? `Additional context: ${context}` : ''}

The email should:
- Be concise (under 150 words)
- Have a compelling subject line
- Personalize based on their industry/company
- Include a clear call-to-action
- Sound natural and conversational

Format the response as JSON with "subject" and "body" fields.`;

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }],
          generationConfig: {
            temperature: 0.7,
          }
        })
      }
    );

    const data = await response.json();
    const generatedText = data.candidates[0]?.content?.parts[0]?.text || '';

    // Parse JSON from response
    const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
    let emailContent;
    
    if (jsonMatch) {
      emailContent = JSON.parse(jsonMatch[0]);
    } else {
      emailContent = {
        subject: 'Quick question about your business',
        body: generatedText
      };
    }

    // Create email campaign draft
    const { data: campaign, error: campaignError } = await supabase
      .from('email_campaigns')
      .insert({
        lead_id: leadId,
        subject: emailContent.subject,
        body: emailContent.body,
        draft_status: 'pending_approval',
        agent_notes: 'Auto-generated by AI assistant'
      })
      .select()
      .single();

    if (campaignError) throw campaignError;

    // Create approval action
    await supabase
      .from('agent_actions')
      .insert({
        action_type: 'email_draft',
        agent_type: 'email_assistant',
        status: 'pending',
        requires_approval: true,
        data: {
          campaign_id: campaign.id,
          lead_id: leadId
        }
      });

    console.log('Email draft created:', campaign.id);

    return new Response(
      JSON.stringify({ success: true, campaign }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('Error:', error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : 'Unknown error' }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
